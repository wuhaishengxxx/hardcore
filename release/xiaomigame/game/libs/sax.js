function XMLReader(){}function parse(a,b,c,e,d){function g(a){var b=a.slice(1,-1);b in c?a=c[b]:"#"===b.charAt(0)?(a=parseInt(b.substr(1).replace("x","0x")),65535<a?(b=55296+((a-=65536)>>10),a=String.fromCharCode(b,56320+(1023&a))):a=String.fromCharCode(a)):a=(d.error("entity not found:"+a),a);return a}function k(b){if(b>t){var c=a.substring(t,b).replace(/&#?\w+;/g,g);n&&f(t);e.characters(c,0,b-t);t=b}}function f(b,c){for(;b>=m&&(c=l.exec(a));)h=c.index,m=h+c[0].length,n.lineNumber++;n.columnNumber=b-h+1}var h=0,m=0,l=/.*(?:\r\n?|\n)|.*$/g,n=e.locator;b=[{currentNSMap:b}];for(var F={},t=0;;){try{var p=a.indexOf("\x3c",t);if(0>p){if(!a.substr(t).match(/^\s*$/)){var y=e.doc,z=y.createTextNode(a.substr(t));y.appendChild(z);e.currentElement=z}break}switch(p>t&&k(p),a.charAt(p+1)){case "/":var q=a.indexOf("\x3e",p+3),u=a.substring(p+2,q),v=b.pop();0>q?(u=a.substring(p+2).replace(/[\s<].*/,""),d.error("end tag name: "+u+" is not complete:"+v.tagName),q=p+1+u.length):u.match(/\s</)&&(u=u.replace(/[\s<].*/,""),d.error("end tag name: "+u+" maybe not complete"),q=p+1+u.length);var A=v.localNSMap,B=v.tagName==u;if(B||v.tagName&&v.tagName.toLowerCase()==u.toLowerCase()){if(e.endElement(v.uri,v.localName,u),A)for(var G in A)e.endPrefixMapping(G);B||d.fatalError("end tag name: "+u+" is not match the current start tagName:"+v.tagName)}else b.push(v);q++;break;case "?":n&&f(p);q=parseInstruction(a,p,e);break;case "!":n&&f(p);q=parseDCC(a,p,e,d);break;default:n&&f(p);var r=new ElementAttributes,w=b[b.length-1].currentNSMap,q=parseElementStartPart(a,p,r,w,g,d),C=r.length;if(!r.closed&&fixSelfClosed(a,q,r.tagName,F)&&(r.closed=!0,c.nbsp||d.warning("unclosed xml attribute")),n&&C){for(var H=copyLocator(n,{}),x=0;C>x;x++){var D=r[x];f(D.offset);D.locator=copyLocator(n,{})}e.locator=H;appendElement(r,e,w)&&b.push(r);e.locator=n}else appendElement(r,e,w)&&b.push(r);"http://www.w3.org/1999/xhtml"!==r.uri||r.closed?q++:q=parseHtmlSpecialContent(a,q,r.tagName,g,e)}}catch(E){d.error("element parse error: "+E),q=-1}q>t?t=q:k(Math.max(p,t)+1)}}function copyLocator(a,b){return b.lineNumber=a.lineNumber,b.columnNumber=a.columnNumber,b}function parseElementStartPart(a,b,c,e,d,g){for(var k,f=++b,h=S_TAG;;){var m=a.charAt(f);switch(m){case "\x3d":if(h===S_ATTR)k=a.slice(b,f);else if(h!==S_ATTR_SPACE)throw Error("attribute equal must after attrName");h=S_EQ;break;case "'":case '"':if(h===S_EQ||h===S_ATTR){if(h===S_ATTR&&(g.warning('attribute value must after "\x3d"'),k=a.slice(b,f)),b=f+1,!(0<(f=a.indexOf(m,b))))throw Error("attribute value no end '"+m+"' match");l=a.slice(b,f).replace(/&#?\w+;/g,d);c.add(k,l,b-1)}else{if(h!=S_ATTR_NOQUOT_VALUE)throw Error('attribute value must after "\x3d"');l=a.slice(b,f).replace(/&#?\w+;/g,d);c.add(k,l,b);g.warning('attribute "'+k+'" missed start quot('+m+")!!");b=f+1}h=S_ATTR_END;break;case "/":switch(h){case S_TAG:c.setTagName(a.slice(b,f));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:h=S_TAG_CLOSE,c.closed=!0;case S_ATTR_NOQUOT_VALUE:case S_ATTR:case S_ATTR_SPACE:break;default:throw Error("attribute invalid close char('/')");}break;case "":return g.error("unexpected end of input"),h==S_TAG&&c.setTagName(a.slice(b,f)),f;case "\x3e":switch(h){case S_TAG:c.setTagName(a.slice(b,f));case S_ATTR_END:case S_TAG_SPACE:case S_TAG_CLOSE:break;case S_ATTR_NOQUOT_VALUE:case S_ATTR:"/"===(l=a.slice(b,f)).slice(-1)&&(c.closed=!0,l=l.slice(0,-1));case S_ATTR_SPACE:h===S_ATTR_SPACE&&(l=k);h==S_ATTR_NOQUOT_VALUE?(g.warning('attribute "'+l+'" missed quot(")!!'),c.add(k,l.replace(/&#?\w+;/g,d),b)):("http://www.w3.org/1999/xhtml"===e[""]&&l.match(/^(?:disabled|checked|selected)$/i)||g.warning('attribute "'+l+'" missed value!! "'+l+'" instead!!'),c.add(l,l,b));break;case S_EQ:throw Error("attribute value missed!!");}return f;case "\u0080":m=" ";default:if(" ">=m)switch(h){case S_TAG:c.setTagName(a.slice(b,f));h=S_TAG_SPACE;break;case S_ATTR:k=a.slice(b,f);h=S_ATTR_SPACE;break;case S_ATTR_NOQUOT_VALUE:var l=a.slice(b,f).replace(/&#?\w+;/g,d);g.warning('attribute "'+l+'" missed quot(")!!');c.add(k,l,b);case S_ATTR_END:h=S_TAG_SPACE}else switch(h){case S_ATTR_SPACE:c.tagName;"http://www.w3.org/1999/xhtml"===e[""]&&k.match(/^(?:disabled|checked|selected)$/i)||g.warning('attribute "'+k+'" missed value!! "'+k+'" instead2!!');c.add(k,k,b);b=f;h=S_ATTR;break;case S_ATTR_END:g.warning('attribute space is required"'+k+'"!!');case S_TAG_SPACE:h=S_ATTR;b=f;break;case S_EQ:h=S_ATTR_NOQUOT_VALUE;b=f;break;case S_TAG_CLOSE:throw Error("elements closed character '/' and '\x3e' must be connected to");}}f++}}function appendElement(a,b,c){for(var e=a.tagName,d=null,g=a.length;g--;){var k=a[g],f=k.qName,h=k.value;if(0<(n=f.indexOf(":")))var m=k.prefix=f.slice(0,n),l=f.slice(n+1),f="xmlns"===m&&l;else l=f,m=null,f="xmlns"===f&&"";k.localName=l;!1!==f&&(null==d&&(d={},_copy(c,c={})),c[f]=d[f]=h,k.uri="http://www.w3.org/2000/xmlns/",b.startPrefixMapping(f,h))}for(g=a.length;g--;)(m=(k=a[g]).prefix)&&("xml"===m&&(k.uri="http://www.w3.org/XML/1998/namespace"),"xmlns"!==m&&(k.uri=c[m||""]));var n=e.indexOf(":");0<n?(m=a.prefix=e.slice(0,n),l=a.localName=e.slice(n+1)):(m=null,l=a.localName=e);g=a.uri=c[m||""];if(b.startElement(g,l,e,a),!a.closed)return a.currentNSMap=c,a.localNSMap=d,!0;if(b.endElement(g,l,e),d)for(m in d)b.endPrefixMapping(m)}function parseHtmlSpecialContent(a,b,c,e,d){if(/^(?:script|textarea)$/i.test(c)){var g=a.indexOf("\x3c/"+c+"\x3e",b);a=a.substring(b+1,g);if(/[&<]/.test(a))return/^script$/i.test(c)?(d.characters(a,0,a.length),g):(a=a.replace(/&#?\w+;/g,e),d.characters(a,0,a.length),g)}return b+1}function fixSelfClosed(a,b,c,e){var d=e[c];return null==d&&(d=a.lastIndexOf("\x3c/"+c+"\x3e"),b>d&&(d=a.lastIndexOf("\x3c/"+c)),e[c]=d),b>d}function _copy(a,b){for(var c in a)b[c]=a[c]}function parseDCC(a,b,c,e){switch(a.charAt(b+2)){case "-":if("-"===a.charAt(b+3))return(d=a.indexOf("--\x3e",b+4))>b?(c.comment(a,b+4,d-b-4),d+3):(e.error("Unclosed comment"),-1);break;default:if("CDATA["==a.substr(b+3,6)){var d=a.indexOf("]]\x3e",b+9);return c.startCDATA(),c.characters(a,b+9,d-b-9),c.endCDATA(),d+3}var d=split(a,b),g=d.length;if(1<g&&/!doctype/i.test(d[0][0]))return a=d[1][0],b=3<g&&/^public$/i.test(d[2][0])&&d[3][0],e=4<g&&d[4][0],d=d[g-1],c.startDTD(a,b&&b.replace(/^(['"])(.*?)\1$/,"$2"),e&&e.replace(/^(['"])(.*?)\1$/,"$2")),c.endDTD(),d.index+d[0].length}return-1}function parseInstruction(a,b,c){var e=a.indexOf("?\x3e",b);return e?(a=a.substring(b,e).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/))?(a[0].length,c.processingInstruction(a[1],a[2]),e+2):-1:-1}function ElementAttributes(){}function _set_proto_(a,b){return a.__proto__=b,a}function split(a,b){var c=[],e=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;e.lastIndex=b;for(e.exec(a);b=e.exec(a);)if(c.push(b),b[1])return c}var nameStartChar=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,nameChar=new RegExp("[\\-\\.0-9"+nameStartChar.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),tagNamePattern=new RegExp("^"+nameStartChar.source+nameChar.source+"*(?::"+nameStartChar.source+nameChar.source+"*)?$"),S_TAG=0,S_ATTR=1,S_ATTR_SPACE=2,S_EQ=3,S_ATTR_NOQUOT_VALUE=4,S_ATTR_END=5,S_TAG_SPACE=6,S_TAG_CLOSE=7;XMLReader.prototype={parse:function(a,b,c){var e=this.domBuilder;e.startDocument();_copy(b,b={});parse(a,b,c,e,this.errorHandler);e.endDocument()}};ElementAttributes.prototype={setTagName:function(a){if(!tagNamePattern.test(a))throw Error("invalid tagName:"+a);this.tagName=a},add:function(a,b,c){if(!tagNamePattern.test(a))throw Error("invalid attribute:"+a);this[this.length++]={qName:a,value:b,offset:c}},length:0,getLocalName:function(a){return this[a].localName},getLocator:function(a){return this[a].locator},getQName:function(a){return this[a].qName},getURI:function(a){return this[a].uri},getValue:function(a){return this[a].value}};_set_proto_({},_set_proto_.prototype)instanceof _set_proto_||(_set_proto_=function(a,b){function c(){}c.prototype=b;c=new c;for(b in a)c[b]=a[b];return c});exports.XMLReader=XMLReader;